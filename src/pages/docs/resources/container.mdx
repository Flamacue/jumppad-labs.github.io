# Container

The `container` resource allows you to run Docker containers.

## Properties

<Properties>
  <Property name="network" type="#network_attachment" required="true" value="">
    Network attaches the container to an existing network defined in a separate stanza. This block can be specified multiple times to attach the container
to multiple networks.
  </Property>
  <Property name="image" type="#image" required="true" value="">
    Image defines a Docker image to use when creating the container.
  </Property>
  <Property name="command" type="[]string" required="false" value="">
    Command allows you to specify a command to execute when starting a container. Command is specified as an array of strings, each part of the
command is a separate string. For example, to start a container and follow logs at /dev/null the following command could be used.

```hcl
    command = [
        "tail",
        "-f",
        "/dev/null"
    ]
    ```
  </Property>
  <Property name="env" type="map[string]string" required="false" value="">
    An env stanza allows you to set environment variables in the container. This stanza can be specified multiple times.

```hcl
env {
  key   = "PATH"
  value = "/usr/local/bin"
}
```

Note the above format will be deprecated soon to use cleaner map based format.

```hcl
env {
  "key": "value"
}
```
  </Property>
  <Property name="volume" type="#volume" required="false" value="">
    A volume allows you to specify a local volume which is mounted to the container when it is created. This stanza can be specified
multiple times.

```hcl
volume {
  source      = "./"
  destination = "/files"
}
```
  </Property>
  <Property name="port" type="#port" required="false" value="">
    A port stanza allows you to expose container ports on the local network or host. This stanza can be specified multiple times.

```hcl
port {
  local = 80
  host  = 8080
}
```
  </Property>
  <Property name="port_range" type="#port_range" required="false" value="">
    A port_range stanza allows you to expose a range of container ports on the local network or host. This stanza can be specified multiple times.

The following example would create 11 ports from 80 to 90 (inclusive) and expose them to the host machine.

```hcl
port {
  range       = "80-90"
  enable_host = true
}
```
  </Property>
  <Property name="privileged" type="boolean" required="false" value="false">
    Should the container run in Docker privileged mode?
  </Property>
  <Property name="health_check" type="#health_check" required="false" value="">
    Define a health check for the container, the resource will only be marked as successfully created when the health check passes.

```hcl
health_check {
  timeout = "30s"
  http    = "http://localhost:8500/v1/status/leader"
}
```
  </Property>
  <Property name="resources" type="#resources" required="false" value="">
    Define resource constraints for the container
  </Property>
  <Property name="max_restart_count" type="number" required="false" value="0">
    The maximum number of times a container will be restarted when it exits with a status code other than 0
  </Property>
  <Property name="run_as" type="#run_as" required="false" value="container defaults">
    Allows the container to be run as a specific user or group.

```hcl
run_as {
  user = "1000"
  group = "nicj"
}
```
  </Property>
  <Property name="build" type="#build" required="false" value="">
    Build a container from the given file and context before running the container.

```hcl
build   {
  file = "./Dockerfile"
  context = "./src"
}
```

Images are cached in the local Docker engine using the following convention.

```shell
jumppad.dev/localcache/<resource_name>:latest
```

Once cached images are not rebuild with every `run` to force the update of an image you can use the `--force-update` flag with `run`.

```shell
jumppad up --force-update ./build
```
  </Property>
</Properties>

---
## network_attachment

Network attachment defines a network to which the container is attached.

<Properties>
  <Property name="id" type="string" required="true" value="">
    ID of the network to attach the container to, specified in reference format. e.g. to attach to a network called `cloud`

```hcl
network {
  id = "network.cloud"
}
```
  </Property>
  <Property name="ip_address" type="string" required="false" value="">
    Static IP address to assign container for the network, the ip address must be within range defined by the network subnet.
If this parameter is omitted an IP address will be automatically assigned.
  </Property>
  <Property name="aliases" type="[]string" required="false" value="">
    Aliases allow alternate names to specified for the container. Aliases can be used to reference a container across the network, the container
will respond to ping and other network resolution using the primary assigned name `[name].container.shipyard.run` and the aliases.

```hcl
network {
  name    = "network.cloud"
  aliases = [
    "alt1.container.shipyard.run", 
    "alt2.container.shipyard.run"
  ]
}
```
  </Property>

  <Property name="name" type="string" required="false" value="" readonly>
    Name will equal the name of the network as created by jumppad.
  </Property>
</Properties>
---

## image

Image defines a Docker image used when creating this container. An Image can be stored in a public or a private repository.

<Properties>
  <Property name="name" type="string" required="true" value="">
    Name of the image to use when creating the container, can either be the full canonical name or short name for Docker official images.
e.g. `consul:v1.6.1` or `docker.io/consul:v1.6.1`.
  </Property>
  <Property name="username" type="string" required="false" value="">
    Username to use when connecting to a private image repository
  </Property>
  <Property name="password" type="string" required="false" value="">
    Password to use when connecting to a private image repository, for both username and password interpolated environment variables can be used
in place of static values.

```hcl
image {
  name = "myregistry.io/myimage:latest"
  username = env("REGISTRY_USERNAME")
  password = env("REGISTRY_PASSWORD")
}
```
  </Property>
</Properties>

---

## volume

A volume type allows the specification of an attached volume.

<Properties>
  <Property name="source" type="string" required="true" value="">
    The source volume to mount in the container, can be specified as a relative `./` or absolute path `/usr/local/bin`. Relative paths are relative to
the file declaring the container.
  </Property>
  <Property name="destination" type="string" required="true" value="">
    The destination in the container to mount the volume to, must be an absolute path.
  </Property>
  <Property name="type" type="string" required="false" value="bind">
    The type of the mount, can be one of the following values:

    - bind: bind the source path to the destination path in the container
    - volume: source is a Docker volume
    - tmpfs: create a temporary filesystem
  </Property>
  <Property name="bind_propagation" type="string" required="false" value="rprivate">
    Configures bind propagation for Docker volume mounts, only applies to bind mounts, can be one of the following values:

    - shared
    - slave
    - private
    - rslave
    - rprivate

    For more information please see the Docker documentation [https://docs.docker.com/storage/bind-mounts/#configure-bind-propagation](https://docs.docker.com/storage/bind-mounts/#configure-bind-propagation)
  </Property>
  <Property name="bind_propagation_non_recursive" type="boolean" required="false" value="false">
    We are going to be 100% honest, we have no idea what this option does, but it is a thing so we made it configuable. 
    Would love a PR if you actually know how this is supposed to work.

    For more information please see the Docker documentation [https://docs.docker.com/storage/bind-mounts/#configure-bind-propagation](https://docs.docker.com/storage/bind-mounts/#configure-bind-propagation)
  </Property>
</Properties>

---

## port

A port stanza defines host to container communications

<Properties>
  <Property name="local" type="string" required="true" value="">
    The local port in the container.
  </Property>
  <Property name="host" type="string" required="true" value="">
    The host port to map the local port to.
  </Property>
  <Property name="protocol" type="string" required="false" value="">
    The protocol to use when exposing the port, can be "tcp", or "udp".
  </Property>
  <Property name="open_in_browser" type="string" required="false" value="/">
    Should a browser window be automatically opened when this resource is created. Browser windows will open at the path specified by this property.
  </Property>
</Properties>

---

## port_range

A port_range stanza defines host to container communications by exposing a range of ports for the container.

<Properties>
  <Property name="range" type="string" required="true" value="">
    The port range to expose, e.g, `8080-8082` would expose the ports `8080`, `8081`, `8082`.
  </Property>
  <Property name="enable_host" type="boolean" required="false" value="false">
    The host port to map the local port to.
  </Property>
  <Property name="protocol" type="string" required="false" value="tcp">
    The protocol to use when exposing the port, can be "tcp", or "udp".
  </Property>
</Properties>

---

## health_check

A health_check stanza allows the definition of a health check which must pass before the container is marked as successfully created.

```hcl
health_check {
  duration = "60s"
  http = "http://myendpoint:9090/health"
  http_status_codes = [200,429] // optional
}
```

<Properties>
  <Property name="timeout" type="duration" required="true" value="">
    The maximum duration to wait before marking the health check as failed. Expressed as a Go duration, e.g. `1s` = 1 second, `100ms` = 100 milliseconds.
  </Property>
  <Property name="http" type="string" required="true" value="">
    The URL to check, health check expects a HTTP status code to be returned by the URL in order to pass the health check. HTTP status codes can be specified
by setting the `http_status_code` parameter. A default code of `200` is configured when `http_status_codes` is not set.
  </Property>
  <Property name="http_status_codes" type="[]number" required="false" value="[200]">
    HTTP status codes returned from the endpoint when called. If the returned status code matches any in the array then the health check will pass.
  </Property>
</Properties>

---

## resources

A resources type allows you to configure the maximum resources which can be consumed.

<Properties>
  <Property name="cpu" type="number" required="false" value="">
    Set the maximum CPU which can be consumed by the container in MHz, 1 CPU == 1000MHz.
  </Property>
  <Property name="cpu_pin" type="[]number" required="false" value="">
    Pin the container CPU consumption to one or more logical CPUs. For example to pin the container to the core 1 and 4.

    ```
    resources {
      cpi_pin = [1,4]
    }
    ```
  </Property>
  <Property name="memory" type="string" required="false" value="">
    Maximum  memory which a container can consume, specified in Megabytes.
  </Property>
</Properties>

---

## run_as

User and Group configuration to be used when running a container, by default Docker runs commands in the container as root id 0.

<Properties>
  <Property name="user" type="string" required="false" value="">
    Linux user ID or user name to run the container as, this overrides the default user configured in the container image. 
  </Property>
  <Property name="group" type="string" required="false" value="">
    Linux group ID or group name to run the container as, this overrides the default group configured in the container image.
  </Property>
</Properties>

---

## build

The build stanza allows the building of a Docker image before running the container resource.

<Properties>
  <Property name="file" type="string" required="true" value="">
    Docker file to use for the build.
  </Property>
  <Property name="context" type="string" required="true" value="">
    Path to the context for the build.
  </Property>
</Properties>

---

## Examples

### Minimal Example

The following example creates a container from an existing registry image.

```hcl
container "unique_name" {
    network {
        name = "network.cloud"
    }

    image {
        name = "consul:1.6.1"
    }
}

network "cloud" {
    subnet = "10.0.0.0/16"
}
```
Run the example:

```shell
shipyard run github.com/shipyard-run/shipyard-website/examples/container//minimal
```

### Full Example

```hcl
container "unique_name" {
    depends_on = ["container.another"]

    network {
        name       = "network.cloud"
        ip_address = "10.0.0.200"
    }

    image {
        name     = "consul:1.6.1"
        username = "repo_username"
        password = "repo_password"
    }

    command = [
        "consul",
        "agent"
    ]

    env {
        key   = "CONSUL_HTTP_ADDR"
        value = "http://localhost:8500"
    }

    volume {
        source      = "./config"
        destination = "/config"
    }

    port {
        source = 8500
        remote = 8500
        host   = 18500
    }
    
    port_range {
        range       = "9000-9002"
        enable_host = true
    }

    privileged = false
}

network "cloud" {
  subnet = "10.0.0.0/16"
}
```

### Build Example

The following example builds a temporary image from the given Dockerfile and context before starting
the container.

```hcl
container "build" {
  build   {
    file = "./Dockerfile"
    context = "./src"
  }

  command = ["/bin/app"]

  port {
    local = 9090
    remote = 9090
    host = 9090
  }

  network {
    name = "network.onprem"
  }
}
```